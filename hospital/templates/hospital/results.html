
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hospital Demand Forecasting - Results</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .glass-effect {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .card-shadow {
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
    
    @media print {
      .no-print {
        display: none !important;
      }
      body {
        background: white !important;
        -webkit-print-color-adjust: exact;
        color-adjust: exact;
      }
      .gradient-bg {
        background: white !important;
      }
      .glass-effect, .card-shadow {
        background: white !important;
        backdrop-filter: none !important;
        box-shadow: none !important;
        border: 1px solid #e5e7eb !important;
      }
      canvas {
        max-height: 300px !important;
      }
      .page-break {
        page-break-before: always;
      }
    }

    @page {
      margin: 0.5in;
      size: A4;
    }
  </style>
</head>
<body class="gradient-bg min-h-screen p-4">

  <!-- Background Pattern -->
  <div class="absolute inset-0 opacity-10">
    <div class="absolute inset-0" style="background-image: radial-gradient(circle at 2px 2px, rgba(255,255,255,0.3) 1px, transparent 0); background-size: 32px 32px;"></div>
  </div>

  <div class="relative z-10 max-w-6xl mx-auto">
    
    <!-- Header Section -->
    <div class="text-center mb-8">
      <div class="inline-flex items-center justify-center w-20 h-20 bg-white/20 rounded-full mb-6 glass-effect">
        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
        </svg>
      </div>
      <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">
        Forecasting Results
      </h1>
      <p class="text-xl text-white/80 font-light">
        Demand predictions for your hospital supplies
      </p>
    </div>

    {% for item_code, result in results.items %}
    <div class="bg-white/95 backdrop-blur-lg rounded-3xl card-shadow p-8 md:p-12 mb-8 {% if not forloop.first %}page-break{% endif %}">
      
      <!-- Item Header -->
      <div class="mb-8">
<h2 class="text-3xl font-bold text-gray-800 mb-2">
  {{ forloop.counter }}. {{ result.description }}
</h2>
        <p class="text-lg text-gray-600 font-medium">Item Code: {{ item_code }}</p>
      </div>

      <!-- Metrics Card -->
      <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-6 mb-8">
        <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
          <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
          Model Performance Metrics
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-white/80 rounded-xl p-4 text-center">
            <p class="text-sm text-gray-600 font-medium mb-1">Mean Absolute Error</p>
            <p class="text-2xl font-bold text-blue-600">{{ result.rf_metrics.MAE|floatformat:2 }}</p>
          </div>
          <div class="bg-white/80 rounded-xl p-4 text-center">
            <p class="text-sm text-gray-600 font-medium mb-1">Mean Absolute Percentage Error</p>
            <p class="text-2xl font-bold text-purple-600">{{ result.rf_metrics.MAPE|floatformat:2 }}%</p>
          </div>
          <div class="bg-white/80 rounded-xl p-4 text-center">
            <p class="text-sm text-gray-600 font-medium mb-1">Root Mean Square Error</p>
            <p class="text-2xl font-bold text-indigo-600">{{ result.rf_metrics.RMSE|floatformat:2 }}</p>
          </div>
        </div>
      </div>

      <!-- Chart Section -->
      <div class="mb-8">
        <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
          <svg class="w-6 h-6 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
          </svg>
          Forecast Visualization
        </h3>
        <div class="bg-white rounded-2xl p-6 shadow-lg">
          <div class="relative h-[350px]">
            <canvas id="chart-{{ item_code }}"></canvas>
          </div>
        </div>
      </div>

      <!-- Data Table -->
      <div>
        <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
          <svg class="w-6 h-6 mr-2 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v3m0 4v6m0 0h10"></path>
          </svg>
          Detailed Forecast Data
        </h3>
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
          <div class="overflow-x-auto">
            <table class="min-w-full forecast-table" data-item-code="{{ item_code }}">
              <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                <tr>
                  <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Week</th>
                  <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Actual</th>
                  <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">RF Prediction</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200">
                {% for week, actual, rf in result.forecast_table %}
                <tr class="hover:bg-gray-50 transition-colors">
                  <td class="px-6 py-4 text-sm text-gray-800 font-medium">{{ week }}</td>
                  <td class="px-6 py-4 text-sm text-gray-600">{{ actual|floatformat:2 }}</td>
                  <td class="px-6 py-4 text-sm text-blue-600 font-medium">{{ rf|floatformat:2 }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      const ctx_{{ forloop.counter }} = document.getElementById('chart-{{ item_code }}').getContext('2d');
      new Chart(ctx_{{ forloop.counter }}, {
        type: 'line',
        data: {
          labels: {{ result.weeks|safe }},
          datasets: [
            {
              label: 'Actual',
              data: {{ result.actual|safe }},
              borderColor: 'rgb(34, 197, 94)',
              backgroundColor: 'rgba(34, 197, 94, 0.1)',
              borderWidth: 3,
              tension: 0.1,
              pointBackgroundColor: 'rgb(34, 197, 94)',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 5
            },
            {
              label: 'Random Forest Prediction',
              data: {{ result.rf_pred|safe }},
              borderColor: 'rgb(168, 85, 247)',
              backgroundColor: 'rgba(168, 85, 247, 0.1)',
              borderWidth: 3,
              tension: 0.1,
              pointBackgroundColor: 'rgb(168, 85, 247)',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 5
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                font: { size: 14, weight: '500' },
                padding: 20,
                usePointStyle: true
              }
            }
          },
          scales: {
            y: {
              title: {
                display: true,
                text: 'Quantity Used',
                font: { size: 14, weight: '600' }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Week Index',
                font: { size: 14, weight: '600' }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            }
          }
        }
      });
    </script>
    {% endfor %}

    <!-- Action Buttons -->
    <div class="text-center space-y-4 md:space-y-0 md:space-x-4 md:flex md:justify-center mt-12 no-print">
      <a href="{% url 'upload_file' %}" class="group inline-flex items-center justify-center px-8 py-4 text-lg font-semibold text-white bg-gradient-to-r from-gray-600 to-gray-700 rounded-2xl shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all duration-300">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        Back to Upload
      </a>

      <button onclick="exportAllTablesCSV()" class="group inline-flex items-center justify-center px-8 py-4 text-lg font-semibold text-white bg-gradient-to-r from-yellow-500 to-orange-500 rounded-2xl shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all duration-300">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        Export as CSV
      </button>

      <button onclick="window.print()" class="group inline-flex items-center justify-center px-8 py-4 text-lg font-semibold text-white bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all duration-300">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
        </svg>
        Print Report
      </button>
    </div>

    <!-- Footer -->
    <div class="text-center mt-12 no-print">
      <p class="text-white/60 text-sm">
      </p>
    </div>
  </div>

  <!-- CSV Export Script - keeping existing functionality -->
  <script>
    function downloadCSV(csv, filename) {
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.setAttribute('href', url);
      a.setAttribute('download', filename);
      a.style.visibility = 'hidden';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }

    function tableToCSV(table) {
      const rows = table.querySelectorAll("tr");
      return Array.from(rows).map(row => {
        const cols = row.querySelectorAll("td, th");
        return Array.from(cols).map(cell => {
          let text = cell.innerText.trim();
          if (text.includes(',') || text.includes('"') || text.includes('\n')) {
            text = '"' + text.replace(/"/g, '""') + '"';
          }
          return text;
        }).join(",");
      }).join("\n");
    }

    function exportAllTablesCSV() {
      const tables = document.querySelectorAll('.forecast-table');
      let allData = [];

      tables.forEach((table, index) => {
        const itemCode = table.getAttribute('data-item-code');
        const csv = tableToCSV(table);

        if (index === 0) {
          allData.push(`Hospital Supply Forecasting Results`);
          allData.push(`Generated on: ${new Date().toLocaleString()}`);
          allData.push('');
        }

        allData.push(`Item Code: ${itemCode}`);
        allData.push(csv);
        allData.push('');
      });

      const finalCSV = allData.join('\n');
      const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
      downloadCSV(finalCSV, `hospital_forecast_all_${timestamp}.csv`);
    }
  </script>

</body>
</html>
